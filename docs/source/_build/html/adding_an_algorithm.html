<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding an Algorithm &mdash; WOODS  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Adding a Dataset" href="adding_a_dataset.html" />
    <link rel="prev" title="Running a Sweep" href="running_a_sweep.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> WOODS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Quick Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#installing-requirements">Installing requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="installation.html#with-conda">With Conda</a></li>
<li class="toctree-l3"><a class="reference internal" href="installation.html#with-venv">With venv</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#clone-locally">Clone locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#run-tests">Run tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="running_a_sweep.html">Running a  Sweep</a><ul>
<li class="toctree-l2"><a class="reference internal" href="running_a_sweep.html#downloading-the-data">Downloading the data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_a_sweep.html#direct-preprocessed-download">Direct Preprocessed Download</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_a_sweep.html#source-download-and-preprocess">Source Download and Preprocess</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_a_sweep.html#datasets-info">Datasets Info</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_a_sweep.html#running-the-sweep">Running the sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_a_sweep.html#compiling-the-results">Compiling the results</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_a_sweep.html#advanced-usage">Advanced usage</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adding an Algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-algorithm">Defining the Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-necessary-pieces">Adding necessary pieces</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-some-tests">Run some tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#try-the-algorithm">Try the algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-a-sweep">Run a sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="adding_a_dataset.html">Adding a Dataset</a><ul>
<li class="toctree-l2"><a class="reference internal" href="adding_a_dataset.html#defining-the-algorithm">Defining the Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_dataset.html#adding-necessary-pieces">Adding necessary pieces</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_dataset.html#run-some-tests">Run some tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_dataset.html#try-the-algorithm">Try the algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_a_dataset.html#run-a-sweep">Run a sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="woods.html">WOODS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="woods.command_launchers.html">woods.command_launchers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.command_launchers.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.command_launchers.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.datasets.html">woods.datasets module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.datasets.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.datasets.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.hyperparams.html">woods.hyperparams module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.hyperparams.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.hyperparams.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.model_selection.html">woods.model_selection module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.model_selection.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.model_selection.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.models.html">woods.models module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.models.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.models.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.objectives.html">woods.objectives module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.objectives.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.objectives.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.train.html">woods.train module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.train.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.train.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.train_step.html">woods.train_step module</a></li>
<li class="toctree-l2"><a class="reference internal" href="woods.utils.html">woods.utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.utils.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.utils.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="woods.scripts.html">woods.scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="woods.scripts.compile_results.html">woods.scripts.compile_results module</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.scripts.download.html">woods.scripts.download module</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.scripts.fetch_and_preprocess.html">woods.scripts.fetch_and_preprocess module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="woods.scripts.fetch_and_preprocess.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="woods.scripts.fetch_and_preprocess.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="woods.scripts.hparams_sweep.html">woods.scripts.hparams_sweep module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="woods.scripts.hparams_sweep.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="woods.scripts.hparams_sweep.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="woods.scripts.main.html">woods.scripts.main module</a></li>
<li class="toctree-l3"><a class="reference internal" href="woods.scripts.visualize_results.html">woods.scripts.visualize_results module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">WOODS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Adding an Algorithm</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/adding_an_algorithm.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-an-algorithm">
<h1>Adding an Algorithm<a class="headerlink" href="#adding-an-algorithm" title="Permalink to this headline"></a></h1>
<p>In this section, we will walk through the process of adding an algorithm to the framework.</p>
<section id="defining-the-algorithm">
<h2>Defining the Algorithm<a class="headerlink" href="#defining-the-algorithm" title="Permalink to this headline"></a></h2>
<p>We first define the algorithm by creating a new class in the objectives module. In this example we will add scaled_ERM which is simply ERM with a random scale factor between 0 and max_scale for each environment in a dataset, where max_scale is an hyperparameter of the objective.</p>
<p>Let’s first define the class and its <strong>int</strong> method to initialize the algorithm.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">scaled_ERM</span><span class="p">(</span><span class="n">ERM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scaled Empirical Risk Minimization (scaled ERM)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">hparams</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">scaled_ERM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hparams</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_scale</span> <span class="o">=</span> <span class="n">hparams</span><span class="p">[</span><span class="s1">&#39;max_scale&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">train_names</span><span class="p">))</span>
</pre></div>
</div>
<p>We then need to define the update function, which take a minibatch of data and compute the loss and update the model according to the algorithm definition. Note here that we do not need to define the predict function, as it is already defined in the base class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minibatches_device</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>

        <span class="c1">## Group all inputs and send to device</span>
        <span class="n">all_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">minibatches_device</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">all_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">minibatches_device</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="n">ts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">PRED_TIME</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">all_x</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="c1">## Reshape the data so the first dimension are environments)</span>
        <span class="n">out_split</span><span class="p">,</span> <span class="n">labels_split</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split_data</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">all_y</span><span class="p">)</span>

        <span class="n">env_losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_split</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out_split</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out_split</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>     <span class="c1"># Number of time steps</span>
                <span class="n">env_losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">out_split</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">t_idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">labels_split</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">t_idx</span><span class="p">])</span>

        <span class="n">objective</span> <span class="o">=</span> <span class="n">env_losses</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Back propagate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">objective</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="adding-necessary-pieces">
<h2>Adding necessary pieces<a class="headerlink" href="#adding-necessary-pieces" title="Permalink to this headline"></a></h2>
<p>Now that our algorithm is defined, we can add it to the list of algorithms at the top of the objectives module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">OBJECTIVES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;ERM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IRM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;VREx&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ANDMask&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IGA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;scaled_ERM&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Before being able to use the algorithm, we need to add the hyper parameters related to this algorithm in the hyperparams module. Note: the name of the funtion needs to be the same as the name of the algorithm followed by _hyper.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scaled_ERM_hyper</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; scaled ERM objective hparam definition </span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        sample (bool): If &#39;&#39;True&#39;&#39;, hyper parameters are gonna be sampled randomly according to their given distributions. Defaults to &#39;&#39;False&#39;&#39; where the default value is chosen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;max_scale&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">10.</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;max_scale&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="mf">1.</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="run-some-tests">
<h2>Run some tests<a class="headerlink" href="#run-some-tests" title="Permalink to this headline"></a></h2>
<p>We can now run a simple test to check that everything is working as expected</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Coming soon...
</pre></div>
</div>
</section>
<section id="try-the-algorithm">
<h2>Try the algorithm<a class="headerlink" href="#try-the-algorithm" title="Permalink to this headline"></a></h2>
<p>Then we can run a training run to see how the algorithm performs on any dataset</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python3 -m woods.main train <span class="se">\</span>
        --dataset Spurious_Fourier <span class="se">\</span>
        --objective scaled_ERM <span class="se">\</span>
        --test_env <span class="m">0</span> <span class="se">\</span>
        --data_path ./data
</pre></div>
</div>
</section>
<section id="run-a-sweep">
<h2>Run a sweep<a class="headerlink" href="#run-a-sweep" title="Permalink to this headline"></a></h2>
<p>Finally, we can run a sweep to see how the algorithm performs on all the datasets</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python3 -m woods.main sweep <span class="se">\</span>
        --objective scaled_ERM <span class="se">\</span>
        --data_path ./data
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="running_a_sweep.html" class="btn btn-neutral float-left" title="Running a Sweep" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="adding_a_dataset.html" class="btn btn-neutral float-right" title="Adding a Dataset" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Jean-Christophe Gagnon-Audet.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>